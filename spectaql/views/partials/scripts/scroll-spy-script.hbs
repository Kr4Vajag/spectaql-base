<script>
(function() {
    function getDocumentOffsetTop(element) {
        let offsetTop = 0;
        while (element) {
            offsetTop += element.offsetTop;
            element = element.offsetParent;
        }
        return offsetTop;
    }

    // ========================================================================
    // Replace the global scrollSpy function with a fixed version (code is copy-paste from original with fix applied)
    // ========================================================================
    window.scrollSpy = function() {
        var INIT_DELAY_MS = 300;
        var SCROLL_DEBOUNCE_MS = 100;
        var RESIZE_DEBOUNCE_MS = 500;
        var PADDING = 5;

        var htmlElement = document.querySelector('html');
        if (htmlElement) {
            var scrollPaddingTop = window.getComputedStyle(htmlElement).scrollPaddingTop;
            if (scrollPaddingTop && typeof scrollPaddingTop === 'string' &&
                scrollPaddingTop !== 'auto' && scrollPaddingTop.endsWith('px')) {
                PADDING = PADDING + parseInt(scrollPaddingTop.split('px')[0]);
            }
        }

        var ACTIVE_CLASS = 'nav-scroll-active';
        var EXPAND_CLASS = 'nav-scroll-expand';
        var EXPANDABLE_SELECTOR = '.nav-group-section';

        var currentIndex = null;
        var sections = [];

        function init() {
            findScrollPositions();
            handleScroll();
            window.addEventListener('scroll', handleScroll);
            window.addEventListener('resize', handleResize);

            // Handle content size change when clicking on `Changelog` list or tabs
            document.addEventListener('click', function(event) {
                var summaryElement = event.target.closest('details > summary');
                var tabLabel = event.target.closest('.tabbed-set > label');
                if (summaryElement || tabLabel) {
                    // Delay to allow content to expand/collapse
                    setTimeout(function () {
                        findScrollPositions(false);
                        handleScroll();
                    }, 250);
                }
            });
        }

        function findScrollPositions(resetCurrentIndex = true) {
            if (resetCurrentIndex) {
                currentIndex = null;
            }

            sections = []; // Reset sections array
            var allScrollableItems = document.querySelectorAll('[data-traverse-target]');
            Array.prototype.forEach.call(allScrollableItems, function(element) {
                // FIX: Use absolute document offset instead of just offsetTop
                sections.push({ id: element.id, top: getDocumentOffsetTop(element) });
            });
        }

        function isElementInViewport(element) {
            var rect = element.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        var handleResize = debounce(function() {
            findScrollPositions();
            handleScroll();
        }, RESIZE_DEBOUNCE_MS);

        var handleScroll = debounce(function() {
            var scrollPosition = document.documentElement.scrollTop || document.body.scrollTop;
            var index = getVisibleSectionIndex(scrollPosition);

            if (index === currentIndex) {
                return;
            }

            currentIndex = index;
            var section = sections[index];

            var activeElement = document.querySelector('.' + ACTIVE_CLASS);
            var nextElement = section ?
                document.querySelector('#nav a[href="#' + section.id + '"]') : null;

            var parentNextElement = getParentSection(nextElement);
            var parentActiveElement = getParentSection(activeElement);
            var isDifferentParent = parentActiveElement !== parentNextElement;

            if (parentActiveElement && isDifferentParent) {
                toggleSectionExpansion(parentActiveElement, false);
            }
            if (parentNextElement && isDifferentParent) {
                toggleSectionExpansion(parentNextElement, true);
            }

            if (nextElement) {
                nextElement.classList.add(ACTIVE_CLASS);
                if (nextElement.scrollIntoViewIfNeeded) {
                    nextElement.scrollIntoViewIfNeeded();
                } else if (nextElement.scrollIntoView && !isElementInViewport(nextElement)) {
                    nextElement.scrollIntoView({ block: 'center', inline: 'start' });
                }
            }

            if (activeElement) {
                activeElement.classList.remove(ACTIVE_CLASS);
            }
        }, SCROLL_DEBOUNCE_MS);

        function toggleSectionExpansion(element, shouldExpand) {
            var classListFunction = shouldExpand ? 'add' : 'remove';
            while (element) {
                element.classList[classListFunction](EXPAND_CLASS);
                element = getParentSection(element.parentNode);
            }
        }

        function getParentSection(element) {
            if (!element || !element.closest) return null;
            return element.closest(EXPANDABLE_SELECTOR);
        }

        function getVisibleSectionIndex(scrollPosition) {
            var positionToCheck = scrollPosition + PADDING;
            for (var i = 0; i < sections.length; i++) {
                var section = sections[i];
                var nextSection = sections[i + 1];
                if (positionToCheck >= section.top &&
                    (!nextSection || positionToCheck < nextSection.top)) {
                    return i;
                }
            }
            return -1;
        }

        setTimeout(init, INIT_DELAY_MS);
    };

    // ========================================================================
    // NAV SECTION COLLAPSE/EXPAND FUNCTIONALITY
    // ========================================================================

    document.addEventListener('DOMContentLoaded', function() {
        const navGroupSectionTitles = document.querySelectorAll('.nav-group-section-title a');

        navGroupSectionTitles.forEach(function(sectionTitleLink) {
            sectionTitleLink.addEventListener('click', function(event) {
                let navGroupSection = sectionTitleLink.closest('.nav-group-section');
                let isCurrentlyExpanded = navGroupSection.classList.contains('nav-scroll-expand');

                if (isCurrentlyExpanded) {
                    event.preventDefault();
                    navGroupSection.classList.remove('nav-scroll-expand');
                } else {
                    // Handles click to expand on section which was collapsed and no scrolling happened afterwards
                    navGroupSection.classList.add('nav-scroll-expand');
                }
            });
        });

        let scrollSpyObserver = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    // Handle nav section expand after manually collapsing it and then scrolling to another item in it
                    if (mutation.target.classList.contains('nav-scroll-active') &&
                        !mutation.target.closest('.nav-group-section').classList.contains('nav-scroll-expand')) {
                        mutation.target.closest('.nav-group-section').classList.add('nav-scroll-expand');
                    }
                }
            });
        });

        let navGroupSectionItems = document.querySelectorAll('.nav-group-section .nav-group-section-items a');
        navGroupSectionItems.forEach(function(sectionItem) {
            scrollSpyObserver.observe(sectionItem, { attributes: true });
        });
    });
})();
</script>
